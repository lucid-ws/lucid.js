<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">server/structures/Client.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lucid-ws/lucid.js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">constants</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ClientStatus">ClientStatus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DisconnectTypes">DisconnectTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Errors">Errors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PacketTypes">PacketTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ProtocolVersion">ProtocolVersion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ServerDefaultOptions">ServerDefaultOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ServerStatus">ServerStatus</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">constants/errors</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INVALID_MESSAGE_FROM_CLIENT">INVALID_MESSAGE_FROM_CLIENT</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">constants/packets</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLIENT_EXISTING_SESSION_REQUEST">CLIENT_EXISTING_SESSION_REQUEST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CLIENT_NEW_SESSION_REQUEST">CLIENT_NEW_SESSION_REQUEST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_ACCEPT_SESSION_REQUEST">SERVER_ACCEPT_SESSION_REQUEST</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_AT_MAXIMUM_CAPACITY">SERVER_AT_MAXIMUM_CAPACITY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SERVER_DISCONNECTING_CLIENT">SERVER_DISCONNECTING_CLIENT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TOOK_TOO_LONG_TO_AUTH">TOOK_TOO_LONG_TO_AUTH</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">server</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/server/ExpressServer.js~LucidExpressServer.html">LucidExpressServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/server/Server.js~LucidServer.html">LucidServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/server/WebSocketServer.js~LucidWebSocketServer.html">LucidWebSocketServer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ExpressServerOptions">ExpressServerOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ServerOptions">ServerOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WebSocketServerOptions">WebSocketServerOptions</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">structures</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/structures/AuthorizedClient.js~AuthorizedClient.html">AuthorizedClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/structures/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/server/structures/UnknownClient.js~UnknownClient.html">UnknownClient</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">server/structures/Client.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

import zlib from &apos;zlib&apos;;
import * as Constants from &apos;../constants/Constants&apos;;

/**
 * Represents a WebSocket Client.
 */
class Client{

  /**
   * Creates a new Client. Developers shouldn&apos;t instantiate Client,
   * the WebSocketServer does it automatically.
   * @param {ws.WebSocket} socket the WebSocket connection
   * @param {LucidWebSocketServer} wss the WSS the Client is connected to.
   */
  constructor(socket, wss) {
    /**
     * The LucidWebSocketServer that the Client is connected to.
     * @type {LucidWebSocketServer}
     */
    this.wss = wss;

    /**
     * The WebSocket connection of the Client.
     * @type {ws.WebSocket}
     */
    this.socket = socket;

    /**
     * Represents whether the Client is authorized or not.
     * @type {Boolean}
     */
    this.authorized = false;

    /**
     * An Array of Intervals. They are stored so they can be cleared if required.
     * @type {Array&lt;Interval&gt;}
     */
    this.intervals = [];

    /**
     * An Array of Timeouts. They are stored so they can be cleared if required.
     * @type {Array&lt;Timeout&gt;}
     */
    this.timeouts = [];

    /**
     * The status of the Client.
     * @type {ClientStatus}
     */
    this.status = null;

    this.attachHandlers();
  }

  /**
   * Attaches event handlers to the WebSocket
   * @private
   */
  attachHandlers() {
    let socket = this.socket;

    socket.on(&apos;message&apos;, (data, flags) =&gt; this.PreEventMessage(data, flags));
    socket.on(&apos;close&apos;, (code, message) =&gt; this.EventClose(code, message));
    socket.on(&apos;error&apos;, (error) =&gt; this.EventError(error));
  }

  /**
   * Removes all message, close and error event listeners.
   */
  detachHandlers() {
    let socket = this.socket;

    socket.removeAllListeners(&apos;message&apos;);
    socket.removeAllListeners(&apos;close&apos;);
    socket.removeAllListeners(&apos;error&apos;);
  }

  /**
   * Handles the WebSocket &apos;message&apos; event and normalizes data
   * @param {String|Buffer} data The received data.
   * @param {Object} flags Object containing &apos;binary&apos; member.
   */
  PreEventMessage(data, flags) {

    // turn data into string

    if (flags.binary) {
      try {
        // try to inflate the data
        data = zlib.inflateSync(data).toString();
      } catch (e) {
        return this.EventError(Constants.Errors.INVALID_MESSAGE_FROM_CLIENT);
      }
    }

    // parse json data
    try {
      data = JSON.parse(data);
    } catch (e) {
      return this.EventError(Constants.Errors.INVALID_MESSAGE_FROM_CLIENT);
    }

    if (!data.t) {
      return this.EventError(Constants.Errors.INVALID_MESSAGE_FROM_CLIENT);
    }

    // data is now a valid packet

    this.EventMessage(data);
  }

  /**
   * Handles normalized data from &apos;PreEventMessage&apos;
   * @param {Object} packet The received packet
   * @abstract
   */
  EventMessage(packet) {

  }

  /**
   * Handles the WebSocket &apos;close&apos; event
   * @param {Number} code The close code
   * @param {String} message The given close message
   */
  EventClose(code, message) {

  }

  /**
   * Handles the WebSocket &apos;error&apos; event
   * @param {Error} error An error
   */
  EventError(error) {

  }

  /**
   * Sends a custom packet to the Client
   * @param {String} type packet type
   * @param {Object} data packet data
   */
  send(type, data) {
    type = &apos;custom_&apos; + type;
    return this.sendInternal(type, data);
  }

  /**
   * Sends an unmodified packet to the Client
   * @param {String} type packet type
   * @param {Object} data packet data
   */
  sendInternal(type, data) {
    let t = type;
    let d = data || {};
    this.socket.send(JSON.stringify({ t, d }));
  }

  /**
   * Kills connection to the client
   * @param {Number} reason A numeric reason, see DisconnectTypes.
   * @param  {Boolean} [returnAllowed=true] States whether the Client is allowed to return to their session
   * after being disconnected.
   * @param {Object} [extra] Extra information about the disconnect, useful for custom disconnect reasons.
   */
  killConnection(reason, returnAllowed=true, extra) {
    let data = {
      r: reason,
    };

    if (extra) {
      data.e = extra;
    }

    if (this.authorized) {
      data.returnAllowed = Boolean(returnAllowed);
    }

    this.sendInternal(Constants.PacketTypes.SERVER_DISCONNECTING_CLIENT, data);

    if (data.returnAllowed) {
      this.cleanWebSocket();
    } else {
      this.cleanWebSocket();
      this.removeReferences();
    }
  }

  /**
   * Terminates the WebSocket and cleans all WebSocket related information, but doesn&apos;t end the session.
   * @ignore
   */
  cleanWebSocket() {
    this.socket.close();

    for (let interval of this.intervals) {
      clearInterval(interval);
    }

    for (let timeout of this.timeouts) {
      clearTimeout(timeout);
    }
  }

  /**
   * Removes references to the Client internally
   * @ignore
   */
  removeReferences() {
    let index = this.wss.connections.indexOf(this);
    if (index &gt; -1) {
      this.wss.connections.splice(index, 1);
    }
  }
}

export default Client;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.6)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
